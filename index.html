<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chewbooty Player Monthly Progression</title>
<style>
Â  :root{
Â  Â  --bg:#0b0b0c;
Â  Â  --panel:#141416;
Â  Â  --panel-2:#0f1011; /* Error fixed: The stray 'a' was removed from this line */
Â  Â  --panel-alt:#111113; /* Added for row alternation */
Â  Â  --muted:#9aa4ad;
Â  Â  --accent:#ffd700;
Â  Â  --success:#2ecc71;
Â  Â  --danger:#ff6b6b;
Â  Â  --link:#66ccff;
Â  Â  --glass: rgba(255,255,255,0.02);
Â  Â  --radius:10px;
Â  Â  --shadow: 0 10px 30px rgba(0,0,0,0.6);
Â  Â  --focus: rgba(102,194,255,0.14);
Â  Â  --mono: "Segoe UI Mono", "Roboto Mono", monospace;
Â  Â  --transition: 180ms cubic-bezier(.2,.9,.2,1);
Â  }

Â  html,body{height:100%}
Â  body{
Â  Â  margin:20px;
Â  Â  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
Â  Â  /* solid dark background (gradient removed as requested) */
Â  Â  background: var(--bg);
Â  Â  color:#e8eef2;
Â  Â  -webkit-font-smoothing:antialiased;
Â  Â  -moz-osx-font-smoothing:grayscale;
Â  Â  line-height:1.35;
Â  }

Â  header{
Â  Â  display:flex;
Â  Â  gap:16px;
Â  Â  align-items:flex-start;
Â  Â  justify-content:space-between;
Â  Â  flex-wrap:wrap;
Â  Â  margin-bottom:14px;
Â  }

Â  h1{
Â  Â  margin:0;
Â  Â  color:var(--accent);
Â  Â  font-size:1.25rem;
Â  Â  letter-spacing:0.2px;
Â  }

Â  /* Winners strip */
Â  .winners-wrap{ display:flex; gap:12px; align-items:stretch; min-width:0; }

Â  .winners-strip{
Â  Â  display:flex;
Â  Â  gap:12px;
Â  Â  background:linear-gradient(180deg,var(--panel),var(--panel-2));
Â  Â  border-radius:var(--radius);
Â  Â  padding:10px;
Â  Â  border:1px solid rgba(255,255,255,0.03);
Â  Â  box-shadow:var(--shadow);
Â  Â  min-width:320px;
Â  Â  align-items:stretch;
Â  Â  transition: transform var(--transition), box-shadow var(--transition);
Â  }

Â  .winners-strip:hover{
Â  Â  transform: translateY(-4px);
Â  Â  box-shadow: 0 18px 40px rgba(0,0,0,0.7);
Â  }

Â  .winners-col{ display:flex; flex-direction:column; gap:8px; min-width:0; flex:1; }

Â  .winners-title{ color:var(--accent); font-size:0.85rem; font-weight:600; }

Â  .winner-row{
Â  Â  display:flex;
Â  Â  gap:10px;
Â  Â  align-items:center;
Â  Â  background:var(--glass);
Â  Â  padding:8px;
Â  Â  border-radius:8px;
Â  Â  font-size:0.9rem;
Â  Â  overflow:hidden;
Â  Â  white-space:nowrap;
Â  Â  text-overflow:ellipsis;
Â  Â  transition: background var(--transition), transform var(--transition);
Â  Â  cursor:default;
Â  }

Â  .winner-row:hover{
Â  Â  background: rgba(255,255,255,0.03);
Â  Â  transform: translateY(-3px);
Â  }

Â  .medal{ width:28px; text-align:center; font-size:1.05rem; transition: transform var(--transition); }
Â  .winner-row:hover .medal{ transform: scale(1.08); }

Â  .winner-name{ flex:1; overflow:hidden; text-overflow:ellipsis; color:#e8eef2; }
Â  .winner-val{ color:var(--muted); font-size:0.9rem; margin-left:6px; }

Â  .winners-controls{ display:flex; align-items:center; gap:8px; }

Â  .btn{
Â  Â  background:transparent;
Â  Â  border:1px solid rgba(255,255,255,0.06);
Â  Â  color:inherit;
Â  Â  padding:8px 10px;
Â  Â  border-radius:8px;
Â  Â  cursor:pointer;
Â  Â  font-size:0.9rem;
Â  Â  transition: background var(--transition), transform var(--transition), box-shadow var(--transition);
Â  }
Â  .btn:hover{ background: rgba(255,255,255,0.02); transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0,0,0,0.6); }
Â  .btn:focus{ outline:3px solid var(--focus); outline-offset:2px; }

Â  /* Table area */
Â  main{ margin-top:6px; }
Â  .table-panel{
Â  Â  background: linear-gradient(180deg,var(--panel),transparent);
Â  Â  border-radius:12px;
Â  Â  padding:10px;
Â  Â  box-shadow:var(--shadow);
Â  Â  /* allow page scrolling so table headers can stick to viewport */
Â  Â  overflow: visible;
Â  }

Â  table{
Â  Â  width:100%;
Â  Â  border-collapse:collapse;
Â  Â  min-width:980px;
Â  Â  font-size:0.95rem;
Â  Â  transition: transform var(--transition);
Â  }

Â  thead th{
Â  Â  position:sticky;
Â  Â  top:0; /* stick to the top of the viewport when page scrolls */
Â  Â  z-index:999; /* ensure headers stay above other content */
Â  Â  background: var(--panel); /* solid header background to avoid transparency artifacts */
Â  Â  color:var(--accent);
Â  Â  padding:10px 12px;
Â  Â  text-align:center;
Â  Â  font-weight:600;
Â  Â  border-bottom:1px solid rgba(255,255,255,0.03);
Â  Â  cursor:pointer;
Â  Â  user-select:none;
Â  Â  transition: background var(--transition), transform var(--transition);
Â  Â  **border-left:1px solid rgba(255,255,255,0.01); /* Subtle column divider */**
Â  }
Â  **thead th:first-child{ border-left: none; } /* Remove divider on first column */**

Â  thead th:hover{ background: rgba(255,255,255,0.02); transform: translateY(-2px); }

Â  tbody td{
Â  Â  padding:10px 12px;
Â  Â  border-top:1px solid rgba(255,255,255,0.02);
Â  Â  text-align:center;
Â  Â  vertical-align:middle;
Â  Â  transition: background var(--transition), color var(--transition);
Â  Â  **border-left:1px solid rgba(255,255,255,0.01); /* Subtle column divider */**
Â  }
Â  **tbody td:first-child{ border-left: none; } /* Remove divider on first column */**

Â  **/* Subtle row color alternation */**
Â  **tr:nth-child(even) td{ background: var(--panel-alt); }**
Â  **tr:nth-child(even) td:hover{ background: rgba(255,255,255,0.03); } /* Keep hover visible */**
Â  tr:hover td{ background: rgba(255,255,255,0.02); }

Â  td[data-cur]{ font-variant-numeric: tabular-nums; }

Â  .oldVal{ color:var(--muted); font-size:0.9em; margin-left:6px; }
Â  .pos{ color:var(--success); font-weight:700; margin-left:6px; }
Â  .neg{ color:var(--danger); font-weight:700; margin-left:6px; }
Â  .zero{ color:var(--muted); font-weight:700; margin-left:6px; }

Â  th[data-sort-dir="asc"]::after{ content:" â–²"; font-size:0.8rem; color:#ddd; margin-left:6px; }
Â  th[data-sort-dir="desc"]::after{ content:" â–¼"; font-size:0.8rem; color:#ddd; margin-left:6px; }

Â  a{ color:var(--link); text-decoration:none; transition: color var(--transition), transform var(--transition); }
Â  a:hover{ color:#aee8ff; transform: translateY(-2px); text-decoration:underline; }

Â  /* cell hover highlight for numeric cells */
Â  tbody td[data-cur]:hover{ background: rgba(102,194,255,0.03); box-shadow: inset 0 0 0 1px rgba(102,194,255,0.02); }

Â  /* medal hover glow */
Â  .medal:hover{ text-shadow: 0 6px 18px rgba(255,215,0,0.12); }

Â  @media (max-width:980px){
Â  Â  .winners-strip{ flex-direction:column; min-width:260px; }
Â  Â  table{ min-width:820px; font-size:0.92rem; }
Â  }

Â  @media (max-width:720px){
Â  Â  header{ flex-direction:column; align-items:flex-start; gap:10px; }
Â  Â  table{ min-width:720px; font-size:0.9rem; }
Â  }

Â  .sr-only{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
</style>
</head>
<body>
Â  <header>
Â  Â  <h1>Chewbooty Player Monthly Progression</h1>

Â  Â  <div class="winners-wrap" style="min-width:0;">
Â  Â  Â  <div id="winnersContainer" class="winners-strip" aria-live="polite" aria-atomic="true">
Â  Â  Â  Â  <div class="winners-col" id="gpGrowth">
Â  Â  Â  Â  Â  <div class="winners-title">Total GP Growth</div>
Â  Â  Â  Â  Â  <div class="winner-row"><div class="medal">â€”</div><div class="winner-name">No positive growth</div><div class="winner-val"></div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="winners-col" id="scoreGrowth">
Â  Â  Â  Â  Â  <div class="winners-title">Total Score Growth</div>
Â  Â  Â  Â  Â  <div class="winner-row"><div class="medal">â€”</div><div class="winner-name">No positive growth</div><div class="winner-val"></div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="winners-controls">
Â  Â  Â  Â  <button id="toggleWinners" class="btn" aria-expanded="true" aria-controls="winnersContainer">Hide winners</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </header>

Â  <main>
Â  Â  <section class="table-panel" aria-labelledby="rosterLabel">
Â  Â  Â  <h2 id="rosterLabel" class="sr-only">Guild roster table</h2>
Â  Â  Â  <table id="guildTable" role="table" aria-describedby="rosterLabel">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <th data-col="Name" scope="col">Player Name (SWGOH Link)</th>
Â  Â  Â  Â  Â  Â  <th data-col="CharacterGP" scope="col">Character GP (Prior Month)</th>
Â  Â  Â  Â  Â  Â  <th data-col="ShipGP" scope="col">Ship GP (Prior Month)</th>
Â  Â  Â  Â  Â  Â  <th data-col="TotalGP" scope="col">Total GP (Prior Month)</th>
Â  Â  Â  Â  Â  Â  <th data-col="LeagueId" scope="col">League</th>
Â  Â  Â  Â  Â  Â  <th data-col="SkillRating" scope="col">Skill Rating</th>
Â  Â  Â  Â  Â  Â  <th data-col="ModScore" scope="col">Mod Score (Prior Month)</th>
Â  Â  Â  Â  Â  Â  <th data-col="GearScore" scope="col">Gear Score (Prior Month)</th>
Â  Â  Â  Â  Â  Â  <th data-col="TotalScore" scope="col">Total Score (Prior Month)</th>
Â  Â  Â  Â  Â  Â  <th data-col="ZetaCount" scope="col">Zetas</th>
Â  Â  Â  Â  Â  Â  <th data-col="OmiCount" scope="col">Omicrons</th>
Â  Â  Â  Â  Â  Â  <th data-col="Speed20" scope="col">Speed â‰¥20</th>
Â  Â  Â  Â  Â  Â  <th data-col="Speed25" scope="col">Speed â‰¥25</th>
Â  Â  Â  Â  Â  Â  <th data-col="UltimateGLCount" scope="col">Ultimate GL</th>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  </table>
Â  Â  </section>
Â  </main>

<script>
/* Core behavior preserved from original:
Â  Â - Loads ChewbootyOld.csv and Chewbooty.csv
Â  Â - Parses CSVs, computes diffs, renders rows
Â  Â - Sorting, top-3 emoji awards, winners strip, toggle control
Â  Â - Kept CSV parsing and numeric handling robust
*/

const FILES = ["ChewbootyOld.csv","Chewbooty.csv"];
const nf = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 });

async function loadFiles(files){
Â  const results = await Promise.all(files.map(async f => {
Â  Â  const res = await fetch(f);
Â  Â  if (!res.ok) throw new Error(`Failed to fetch ${f}: ${res.status}`);
Â  Â  return res.text();
Â  }));
Â  return results;
}

function parseCSV(text){
Â  if (!text) return { header:[], data:[] };
Â  const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(Boolean);
Â  const rows = lines.map(line => {
Â  Â  const cells = [];
Â  Â  let cur = "", inQuote = false;
Â  Â  for (let i=0;i<line.length;i++){
Â  Â  Â  const ch = line[i], next = line[i+1];
Â  Â  Â  if (ch === '"' && inQuote && next === '"'){ cur += '"'; i++; }
Â  Â  Â  else if (ch === '"'){ inQuote = !inQuote; }
Â  Â  Â  else if (ch === ',' && !inQuote){ cells.push(cur.trim()); cur = ""; }
Â  Â  Â  else { cur += ch; }
Â  Â  }
Â  Â  cells.push(cur.trim());
Â  Â  return cells.map(c => c.replace(/^"|"$/g,"").trim());
Â  });
Â  const header = rows.length ? rows[0].map(h => h.replace(/^\uFEFF/,"").trim()) : [];
Â  const data = rows.slice(1);
Â  return { header, data };
}

function getIndexMap(header){
Â  const map = {};
Â  header.forEach((h,i) => map[h] = i);
Â  return map;
}

function safeNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }

function formatDiff(diff, decimals=0){
Â  const cls = diff > 0 ? "pos" : diff < 0 ? "neg" : "zero";
Â  const sign = (diff > 0) ? "+" : "";
Â  const val = (typeof diff === "number")
Â  Â  ? (decimals > 0 ? diff.toFixed(decimals) : nf.format(diff))
Â  Â  : diff;
Â  return `<span class="${cls}">${sign}${val}</span>`;
}

function escapeHtml(str){
Â  if (typeof str !== "string") return "";
Â  return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function extractLeadingNumber(text){
Â  if (!text) return 0;
Â  const m = text.replace(/[,+]/g,"").match(/-?\d+(\.\d+)?/);
Â  return m ? Number(m[0]) : 0;
}

function createRowHTML(data){
Â  return `
Â  Â  <td style="text-align:left" data-name="${escapeHtml(data.playerName).toLowerCase()}">${data.playerLink}</td>

Â  Â  <td data-cur="${data.newCharGP}" data-diff="${data.diffCharGP}">
Â  Â  Â  ${nf.format(data.newCharGP)}
Â  Â  Â  <span class="oldVal">(${nf.format(data.oldCharGP)})</span>
Â  Â  Â  ${formatDiff(data.diffCharGP,0)}
Â  Â  </td>

Â  Â  <td data-cur="${data.newShipGP}" data-diff="${data.diffShipGP}">
Â  Â  Â  ${nf.format(data.newShipGP)}
Â  Â  Â  <span class="oldVal">(${nf.format(data.oldShipGP)})</span>
Â  Â  Â  ${formatDiff(data.diffShipGP,0)}
Â  Â  </td>

Â  Â  <td data-cur="${data.newTotalGP}" data-diff="${data.diffTotalGP}">
Â  Â  Â  ${nf.format(data.newTotalGP)}
Â  Â  Â  <span class="oldVal">(${nf.format(data.oldTotalGP)})</span>
Â  Â  Â  ${formatDiff(data.diffTotalGP,0)}
Â  Â  </td>

Â  Â  <td>${escapeHtml(data.league)}</td>
Â  Â  <td>${escapeHtml(data.skillRating)}</td>

Â  Â  <td data-cur="${data.newModScore.toFixed(2)}" data-diff="${data.diffMod}">
Â  Â  Â  ${data.newModScore.toFixed(2)}
Â  Â  Â  <span class="oldVal">(${data.oldModScore.toFixed(2)})</span>
Â  Â  Â  ${formatDiff(data.diffMod,2)}
Â  Â  </td>

Â  Â  <td data-cur="${data.newGearScore.toFixed(2)}" data-diff="${data.diffGear}">
Â  Â  Â  ${data.newGearScore.toFixed(2)}
Â  Â  Â  <span class="oldVal">(${data.oldGearScore.toFixed(2)})</span>
Â  Â  Â  ${formatDiff(data.diffGear,2)}
Â  Â  </td>

Â  Â  <td data-cur="${data.newTotalScore.toFixed(2)}" data-diff="${data.diffTotalScore}">
Â  Â  Â  ${data.newTotalScore.toFixed(2)}
Â  Â  Â  <span class="oldVal">(${data.oldTotalScore.toFixed(2)})</span>
Â  Â  Â  ${formatDiff(data.diffTotalScore,2)}
Â  Â  </td>

Â  Â  <td>
Â  Â  Â  ${data.newZetas}
Â  Â  Â  <span class="oldVal">(${data.oldZetas})</span>
Â  Â  Â  ${formatDiff(data.diffZetas,0)}
Â  Â  </td>

Â  Â  <td>
Â  Â  Â  ${data.newOmis}
Â  Â  Â  <span class="oldVal">(${data.oldOmis})</span>
Â  Â  Â  ${formatDiff(data.diffOmis,0)}
Â  Â  </td>

Â  Â  <td>
Â  Â  Â  ${data.newSpeed20}
Â  Â  Â  <span class="oldVal">(${data.oldSpeed20})</span>
Â  Â  Â  ${formatDiff(data.diffSpeed20,0)}
Â  Â  </td>

Â  Â  <td>
Â  Â  Â  ${data.newSpeed25}
Â  Â  Â  <span class="oldVal">(${data.oldSpeed25})</span>
Â  Â  Â  ${formatDiff(data.diffSpeed25,0)}
Â  Â  </td>

Â  Â  <td>
Â  Â  Â  ${data.newGLs}
Â  Â  Â  <span class="oldVal">(${data.oldGLs})</span>
Â  Â  Â  ${formatDiff(data.diffGLs,0)}
Â  Â  </td>
Â  `;
}

/* Updated addTopThreeEmojis: store plain winner objects {name, diff} for the winners strip */
function addTopThreeEmojis(){
Â  const table = document.getElementById("guildTable");
Â  const rows = Array.from(table.tBodies[0].rows);
Â  const emojis = ["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"];
Â  const TOTAL_GP_IDX = 3;
Â  const TOTAL_SCORE_IDX = 8;

Â  // Clear any previous emojis in those columns first (to avoid duplicates on re-render)
Â  rows.forEach(r => {
Â  Â  [TOTAL_GP_IDX, TOTAL_SCORE_IDX].forEach(idx => {
Â  Â  Â  const cell = r.cells[idx];
Â  Â  Â  if (cell) {
Â  Â  Â  Â  cell.innerHTML = cell.innerHTML.replace(/ ðŸ¥‡| ðŸ¥ˆ| ðŸ¥‰/g, "");
Â  Â  Â  }
Â  Â  });
Â  });

Â  // Helper to compute winners and return plain objects
Â  function computeWinners(idx) {
Â  Â  const ranked = rows.map(r => {
Â  Â  Â  const cell = r.cells[idx];
Â  Â  Â  const diffAttr = cell && cell.getAttribute ? cell.getAttribute("data-diff") : null;
Â  Â  Â  const diff = diffAttr !== null ? Number(diffAttr || 0) : 0;
Â  Â  Â  const name = (r.cells[0] && (r.cells[0].innerText || "")).trim();
Â  Â  Â  return { cell, diff, name };
Â  Â  })
Â  Â  .filter(e => e.diff > 0) // only positive changes
Â  Â  .sort((a, b) => b.diff - a.diff);

Â  Â  // award emojis visually in the table cells
Â  Â  ranked.slice(0, 3).forEach((entry, rank) => {
Â  Â  Â  const emoji = emojis[rank];
Â  Â  Â  if (entry.cell && !entry.cell.innerHTML.includes(emoji)) {
Â  Â  Â  Â  entry.cell.innerHTML = entry.cell.innerHTML + " " + emoji;
Â  Â  Â  }
Â  Â  });

Â  Â  // return plain objects for winners strip rendering
Â  Â  return ranked.slice(0, 3).map(e => ({ name: e.name, diff: e.diff }));
Â  }

Â  const gpWinners = computeWinners(TOTAL_GP_IDX);
Â  const scoreWinners = computeWinners(TOTAL_SCORE_IDX);

Â  // Save winners data on the table element for the winners strip to read
Â  table._gpWinners = gpWinners;
Â  table._scoreWinners = scoreWinners;
}

function renderWinnersStrip(){
Â  const tableEl = document.getElementById("guildTable");
Â  const gpWinners = tableEl._gpWinners || [];
Â  const scoreWinners = tableEl._scoreWinners || [];

Â  const gpContainer = document.getElementById("gpGrowth");
Â  const scoreContainer = document.getElementById("scoreGrowth");

Â  // clear existing rows (keep title)
Â  gpContainer.querySelectorAll(".winner-row").forEach(n => n.remove());
Â  scoreContainer.querySelectorAll(".winner-row").forEach(n => n.remove());

Â  function renderCategory(container, winners, valueLabel) {
Â  Â  if (!winners.length) {
Â  Â  Â  const row = document.createElement("div");
Â  Â  Â  row.className = "winner-row";
Â  Â  Â  row.innerHTML = `<div class="medal">â€”</div><div class="winner-name">No positive growth</div><div class="winner-val"></div>`;
Â  Â  Â  container.appendChild(row);
Â  Â  Â  return;
Â  Â  }
Â  Â  winners.forEach((w, i) => {
Â  Â  Â  const row = document.createElement("div");
Â  Â  Â  row.className = "winner-row";
Â  Â  Â  const emoji = i === 0 ? "ðŸ¥‡" : i === 1 ? "ðŸ¥ˆ" : "ðŸ¥‰";
Â  Â  Â  const nameText = (w.name || "").trim() || "Unknown";
Â  Â  Â  const valueText = (typeof w.diff === "number") ? (w.diff > 0 ? `+${Number(w.diff).toLocaleString()}` : `${Number(w.diff).toLocaleString()}`) : "";
Â  Â  Â  row.innerHTML = `<div class="medal">${emoji}</div><div class="winner-name" title="${escapeHtml(nameText)}">${escapeHtml(nameText)}</div><div class="winner-val">${escapeHtml(valueText)}</div>`;
Â  Â  Â  container.appendChild(row);
Â  Â  });
Â  }

Â  renderCategory(gpContainer, gpWinners, "GP");
Â  renderCategory(scoreContainer, scoreWinners, "Score");
}

function makeSortable(){
Â  const headers = Array.from(document.querySelectorAll("th[data-col]"));
Â  headers.forEach(th => {
Â  Â  if (!th.dataset.sortDir) th.dataset.sortDir = "";
Â  Â  th.addEventListener("click", () => {
Â  Â  Â  const col = th.getAttribute("data-col");
Â  Â  Â  const current = th.dataset.sortDir || "";
Â  Â  Â  let newDir;
Â  Â  Â  if (current === "") newDir = (col === "Name") ? "asc" : "desc";
Â  Â  Â  else if (current === "asc") newDir = "desc";
Â  Â  Â  else newDir = "asc";
Â  Â  Â  headers.forEach(h => h.dataset.sortDir = "");
Â  Â  Â  th.dataset.sortDir = newDir;
Â  Â  Â  sortTable(col, newDir);
Â  Â  Â  headers.forEach(h => h.style.opacity = h === th ? "1" : "0.95");
Â  Â  });
Â  });
}

function sortTable(col, dir){
Â  const table = document.getElementById("guildTable");
Â  const rows = Array.from(table.tBodies[0].rows);
Â  const headerCells = Array.from(table.tHead.rows[0].cells);
Â  const idx = headerCells.findIndex(c => c.getAttribute("data-col") === col);
Â  if (idx === -1) return;
Â  if (!dir){
Â  Â  const th = headerCells[idx];
Â  Â  dir = th && th.dataset.sortDir ? th.dataset.sortDir : (col === "Name" ? "asc" : "desc");
Â  }

Â  rows.sort((a,b) => {
Â  Â  if (col === "Name"){
Â  Â  Â  const nameA = (a.cells[0].getAttribute("data-name") || a.cells[0].innerText || "").toLowerCase();
Â  Â  Â  const nameB = (b.cells[0].getAttribute("data-name") || b.cells[0].innerText || "").toLowerCase();
Â  Â  Â  if (nameA < nameB) return dir === "asc" ? -1 : 1;
Â  Â  Â  if (nameA > nameB) return dir === "asc" ? 1 : -1;
Â  Â  Â  return 0;
Â  Â  } else {
Â  Â  Â  const numA = extractLeadingNumber(a.cells[idx].innerText);
Â  Â  Â  const numB = extractLeadingNumber(b.cells[idx].innerText);
Â  Â  Â  if (numA === numB) return 0;
Â  Â  Â  return dir === "asc" ? (numA - numB) : (numB - numA);
Â  Â  }
Â  });

Â  rows.forEach(r => table.tBodies[0].appendChild(r));
}

/* Toggle winners strip */
(function attachToggle(){
Â  const btn = document.getElementById("toggleWinners");
Â  const container = document.getElementById("winnersContainer");
Â  if (!btn || !container) return;
Â  btn.addEventListener("click", () => {
Â  Â  const isHidden = container.style.display === "none";
Â  Â  container.style.display = isHidden ? "flex" : "none";
Â  Â  btn.textContent = isHidden ? "Hide winners" : "Show winners";
Â  Â  btn.setAttribute("aria-expanded", String(isHidden));
Â  });
})();

/* Main render flow */
async function renderComparison(){
Â  try {
Â  Â  const [oldCSV, newCSV] = await loadFiles(FILES);
Â  Â  const old = parseCSV(oldCSV);
Â  Â  const newer = parseCSV(newCSV);
Â  Â  const newMap = getIndexMap(newer.header);
Â  Â  const oldMap = getIndexMap(old.header);
Â  Â  const tbody = document.querySelector("#guildTable tbody");
Â  Â  tbody.innerHTML = "";

Â  Â  const fragment = document.createDocumentFragment();

Â  Â  newer.data.forEach(row => {
Â  Â  Â  const allyNew = (row[newMap["AllyCode"]] || "").trim();
Â  Â  Â  let oldRow = null;
Â  Â  Â  if (allyNew && oldMap["AllyCode"] !== undefined){
Â  Â  Â  Â  oldRow = old.data.find(r => (r[oldMap["AllyCode"]]||"").trim() === allyNew);
Â  Â  Â  }
Â  Â  Â  if (!oldRow && oldMap["Name"] !== undefined){
Â  Â  Â  Â  const nameNew = (row[newMap["Name"]] || "").trim();
Â  Â  Â  Â  oldRow = old.data.find(r => (r[oldMap["Name"]]||"").trim() === nameNew);
Â  Â  Â  }

Â  Â  Â  const newCharGP = safeNum(row[newMap["CharacterGP"]]);
Â  Â  Â  const newShipGP = safeNum(row[newMap["ShipGP"]]);
Â  Â  Â  const newTotalGP = newCharGP + newShipGP;
Â  Â  Â  const newModScore = safeNum(row[newMap["ModScore"]]);
Â  Â  Â  const newGearScore = safeNum(row[newMap["GearScore"]]);
Â  Â  Â  const newTotalScore = safeNum(row[newMap["TotalScore"]]);
Â  Â  Â  const newZetas = safeNum(row[newMap["ZetaCount"]]);
Â  Â  Â  const newOmis = safeNum(row[newMap["OmiCount"]]);
Â  Â  Â  const newSpeed20 = safeNum(row[newMap["Speed20"]]);
Â  Â  Â  const newSpeed25 = safeNum(row[newMap["Speed25"]]);
Â  Â  Â  const newGLs = safeNum(row[newMap["UltimateGLCount"]]);

Â  Â  Â  const oldCharGP = oldRow ? safeNum(oldRow[oldMap["CharacterGP"]]) : 0;
Â  Â  Â  const oldShipGP = oldRow ? safeNum(oldRow[oldMap["ShipGP"]]) : 0;
Â  Â  Â  const oldTotalGP = oldCharGP + oldShipGP;
Â  Â  Â  const oldModScore = oldRow ? safeNum(oldRow[oldMap["ModScore"]]) : 0;
Â  Â  Â  const oldGearScore = oldRow ? safeNum(oldRow[oldMap["GearScore"]]) : 0;
Â  Â  Â  const oldTotalScore = oldRow ? safeNum(oldRow[oldMap["TotalScore"]]) : 0;
Â  Â  Â  const oldZetas = oldRow ? safeNum(oldRow[oldMap["ZetaCount"]]) : 0;
Â  Â  Â  const oldOmis = oldRow ? safeNum(oldRow[oldMap["OmiCount"]]) : 0;
Â  Â  Â  const oldSpeed20 = oldRow ? safeNum(oldRow[oldMap["Speed20"]]) : 0;
Â  Â  Â  const oldSpeed25 = oldRow ? safeNum(oldRow[oldMap["Speed25"]]) : 0;
Â  Â  Â  const oldGLs = oldRow ? safeNum(oldRow[oldMap["UltimateGLCount"]]) : 0;

Â  Â  Â  const diffCharGP = newCharGP - oldCharGP;
Â  Â  Â  const diffShipGP = newShipGP - oldShipGP;
Â  Â  Â  const diffTotalGP = newTotalGP - oldTotalGP;
Â  Â  Â  const diffMod = newModScore - oldModScore;
Â  Â  Â  const diffGear = newGearScore - oldGearScore;
Â  Â  Â  const diffTotalScore = newTotalScore - oldTotalScore;
Â  Â  Â  const diffZetas = newZetas - oldZetas;
Â  Â  Â  const diffOmis = newOmis - oldOmis;
Â  Â  Â  const diffSpeed20 = newSpeed20 - oldSpeed20;
Â  Â  Â  const diffSpeed25 = newSpeed25 - oldSpeed25;
Â  Â  Â  const diffGLs = newGLs - oldGLs;

Â  Â  Â  const playerName = (row[newMap["Name"]] || "").trim();
Â  Â  Â  const playerLink = allyNew
Â  Â  Â  Â  ? `<a href="https://swgoh.gg/p/${encodeURIComponent(allyNew)}/" target="_blank" rel="noopener noreferrer">${escapeHtml(playerName)}</a>`
Â  Â  Â  Â  : escapeHtml(playerName);

Â  Â  Â  const data = {
Â  Â  Â  Â  playerName, playerLink,
Â  Â  Â  Â  newCharGP, newShipGP, newTotalGP, newModScore, newGearScore, newTotalScore,
Â  Â  Â  Â  newZetas, newOmis, newSpeed20, newSpeed25, newGLs,
Â  Â  Â  Â  oldCharGP, oldShipGP, oldTotalGP, oldModScore, oldGearScore, oldTotalScore,
Â  Â  Â  Â  oldZetas, oldOmis, oldSpeed20, oldSpeed25, oldGLs,
Â  Â  Â  Â  diffCharGP, diffShipGP, diffTotalGP, diffMod, diffGear, diffTotalScore,
Â  Â  Â  Â  diffZetas, diffOmis, diffSpeed20, diffSpeed25, diffGLs,
Â  Â  Â  Â  league: row[newMap["LeagueId"]] || "",
Â  Â  Â  Â  skillRating: row[newMap["SkillRating"]] || ""
Â  Â  Â  };

Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  tr.innerHTML = createRowHTML(data);
Â  Â  Â  fragment.appendChild(tr);
Â  Â  });

Â  Â  tbody.appendChild(fragment);

Â  Â  makeSortable();
Â  Â  addTopThreeEmojis();
Â  Â  renderWinnersStrip();
Â  } catch (err){
Â  Â  console.error("Error loading CSVs:", err);
Â  Â  const tbody = document.querySelector("#guildTable tbody");
Â  Â  tbody.innerHTML = `<tr><td colspan="14" style="color:#f88; text-align:center;">Error loading CSV files. Check console for details.</td></tr>`;
Â  }
}

document.addEventListener("DOMContentLoaded", () => {
Â  renderComparison();
});
</script>
</body>
</html>
