<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chewbooty Roster</title>
  <style>
    :root {
      --bg:#1c1c1c;
      --panel:#2b2b2b;
      --panel-2:#232323;
      --muted:#bbb;
      --accent:#ffd700;
      --green:#00ff00;
      --red:#ff4444;
      --link:#66ccff;
    }

    body { font-family: Arial, sans-serif; background:var(--bg); color:#f0f0f0; margin:20px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap; margin-bottom:12px; }
    h1 { margin:0; color:var(--accent); font-size:20px; text-align:left; }

    /* Inline winners strip (integrated into page, not fixed) */
    .winners-strip {
      display:flex;
      gap:12px;
      align-items:stretch;
      background:linear-gradient(180deg,var(--panel),var(--panel-2));
      border:1px solid #444;
      padding:8px;
      border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.45);
      color:#f0f0f0;
      min-width:0;
      flex:1 1 420px;
    }
    .winners-col {
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
      flex:1;
    }
    .winners-title { color:var(--accent); font-size:13px; margin:0 0 4px 0; }
    .winner-row {
      display:flex;
      align-items:center;
      gap:8px;
      background:rgba(255,255,255,0.02);
      padding:6px 8px;
      border-radius:6px;
      font-size:13px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .medal { width:22px; text-align:center; font-size:16px; }
    .winner-name { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:#e8e8e8; }
    .winner-val { color:var(--muted); font-size:12px; margin-left:6px; }

    /* collapse control */
    .winners-controls { display:flex; align-items:center; gap:8px; }
    .toggle-btn {
      background:transparent;
      border:1px solid #444;
      color:#f0f0f0;
      padding:6px 8px;
      border-radius:6px;
      cursor:pointer;
      font-size:13px;
    }

    /* Table */
    table { width:100%; border-collapse:collapse; margin-top:12px; background:#2a2a2a; }
    th, td { border:1px solid #444; padding:6px 8px; text-align:center; vertical-align:middle; }
    th { background:#333; color:var(--accent); cursor:pointer; position:sticky; top:0; z-index:2; }
    tr:nth-child(even) { background:#242424; }
    tr:hover { background:#3a3a3a; }
    a { color:var(--link); text-decoration:none; }
    a:hover { text-decoration:underline; }
    .oldVal { color:var(--muted); font-size:0.9em; margin-left:6px; }
    .pos { color:var(--green); font-weight:bold; margin-left:6px; }
    .neg { color:var(--red); font-weight:bold; margin-left:6px; }
    .zero { color:var(--muted); font-weight:bold; margin-left:6px; }

    @media (max-width:900px) {
      table { font-size:13px; }
      th, td { padding:6px; }
      header { flex-direction:column; align-items:flex-start; gap:8px; }
      .winners-strip { flex-direction:column; gap:8px; width:100%; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Chewbooty Guild Roster</h1>

    <!-- Integrated winners strip: inline, non-blocking, collapsible -->
    <div style="display:flex; align-items:center; gap:12px; min-width:0;">
      <div id="winnersContainer" class="winners-strip" aria-live="polite">
        <div class="winners-col" id="gpGrowth">
          <div class="winners-title">Total GP Growth</div>
          <!-- placeholder rows; JS will populate -->
          <div class="winner-row"><div class="medal">â€”</div><div class="winner-name">No positive growth</div><div class="winner-val"></div></div>
        </div>

        <div class="winners-col" id="scoreGrowth">
          <div class="winners-title">Total Score Growth</div>
          <div class="winner-row"><div class="medal">â€”</div><div class="winner-name">No positive growth</div><div class="winner-val"></div></div>
        </div>
      </div>

      <div class="winners-controls">
        <button id="toggleWinners" class="toggle-btn" aria-expanded="true" aria-controls="winnersContainer">Hide winners</button>
      </div>
    </div>
  </header>

  <table id="guildTable">
    <thead>
      <tr>
        <th data-col="Name">Player (link)</th>
        <th data-col="CharacterGP">Character GP (Prior Month)</th>
        <th data-col="ShipGP">Ship GP (Prior Month)</th>
        <th data-col="TotalGP">Total GP (Prior Month)</th>
        <th data-col="LeagueId">League</th>
        <th data-col="SkillRating">Skill Rating</th>
        <th data-col="ModScore">Mod Score (Prior Month)</th>
        <th data-col="GearScore">Gear Score (Prior Month)</th>
        <th data-col="TotalScore">Total Score (Prior Month)</th>
        <th data-col="ZetaCount">Zetas</th>
        <th data-col="OmiCount">Omicrons</th>
        <th data-col="Speed20">Speed â‰¥20</th>
        <th data-col="Speed25">Speed â‰¥25</th>
        <th data-col="UltimateGLCount">Ultimate GL</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const FILES = ["ChewbootyOld.csv","Chewbooty.csv"];

Promise.all(FILES.map(f => fetch(f).then(r => {
  if (!r.ok) throw new Error(`Failed to fetch ${f}: ${r.status}`);
  return r.text();
})))
  .then(([oldCSV, newCSV]) => renderComparison(oldCSV, newCSV))
  .catch(err => {
    console.error("Error loading CSVs:", err);
    const tbody = document.querySelector("#guildTable tbody");
    tbody.innerHTML = `<tr><td colspan="14" style="color:#f88; text-align:center;">Error loading CSV files. Check console for details.</td></tr>`;
  });

function parseCSV(csvText) {
  if (!csvText) return { header: [], data: [] };
  const lines = csvText.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n").filter(l => l.trim() !== "");
  const rows = lines.map(line => {
    const out = [];
    let cur = "", inQuote = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i], next = line[i+1];
      if (ch === '"' && inQuote && next === '"') { cur += '"'; i++; }
      else if (ch === '"') { inQuote = !inQuote; }
      else if (ch === ',' && !inQuote) { out.push(cur.trim()); cur = ""; }
      else { cur += ch; }
    }
    out.push(cur.trim());
    return out.map(c => c.replace(/^"|"$/g, "").trim());
  });
  const header = rows.length ? rows[0].map(h => h.replace(/^\uFEFF/, "").trim()) : [];
  const data = rows.slice(1);
  return { header, data };
}

function formatDiff(diff, decimals = 0) {
  const cls = diff > 0 ? "pos" : diff < 0 ? "neg" : "zero";
  const val = typeof diff === "number"
    ? (decimals > 0 ? diff.toFixed(decimals) : Number(diff).toLocaleString())
    : diff;
  const sign = (typeof diff === "number" && diff > 0) ? "+" : "";
  return `<span class="${cls}">${sign}${val}</span>`;
}

function getIndexMap(header) {
  const map = {};
  header.forEach((h, i) => { map[h] = i; });
  return map;
}

function renderComparison(oldText, newText) {
  const old = parseCSV(oldText);
  const newer = parseCSV(newText);

  const newMap = getIndexMap(newer.header);
  const oldMap = getIndexMap(old.header);

  const tbody = document.querySelector("#guildTable tbody");
  tbody.innerHTML = "";

  newer.data.forEach(row => {
    const allyNew = (row[newMap["AllyCode"]] || "").trim();
    let oldRow = null;
    if (allyNew && oldMap["AllyCode"] !== undefined) {
      oldRow = old.data.find(r => (r[oldMap["AllyCode"]]||"").trim() === allyNew);
    }
    if (!oldRow) {
      const nameNew = (row[newMap["Name"]] || "").trim();
      if (oldMap["Name"] !== undefined) {
        oldRow = old.data.find(r => (r[oldMap["Name"]]||"").trim() === nameNew);
      }
    }

    // current values
    const newCharGP = Number(row[newMap["CharacterGP"]] || 0);
    const newShipGP = Number(row[newMap["ShipGP"]] || 0);
    const newTotalGP = newCharGP + newShipGP;
    const newModScore = Number(row[newMap["ModScore"]] || 0);
    const newGearScore = Number(row[newMap["GearScore"]] || 0);
    const newTotalScore = Number(row[newMap["TotalScore"]] || 0);
    const newZetas = Number(row[newMap["ZetaCount"]] || 0);
    const newOmis = Number(row[newMap["OmiCount"]] || 0);
    const newSpeed20 = Number(row[newMap["Speed20"]] || 0);
    const newSpeed25 = Number(row[newMap["Speed25"]] || 0);
    const newGLs = Number(row[newMap["UltimateGLCount"]] || 0);

    // old values
    const oldCharGP = oldRow ? Number(oldRow[oldMap["CharacterGP"]] || 0) : 0;
    const oldShipGP = oldRow ? Number(oldRow[oldMap["ShipGP"]] || 0) : 0;
    const oldTotalGP = oldCharGP + oldShipGP;
    const oldModScore = oldRow ? Number(oldRow[oldMap["ModScore"]] || 0) : 0;
    const oldGearScore = oldRow ? Number(oldRow[oldMap["GearScore"]] || 0) : 0;
    const oldTotalScore = oldRow ? Number(oldRow[oldMap["TotalScore"]] || 0) : 0;
    const oldZetas = oldRow ? Number(oldRow[oldMap["ZetaCount"]] || 0) : 0;
    const oldOmis = oldRow ? Number(oldRow[oldMap["OmiCount"]] || 0) : 0;
    const oldSpeed20 = oldRow ? Number(oldRow[oldMap["Speed20"]] || 0) : 0;
    const oldSpeed25 = oldRow ? Number(oldRow[oldMap["Speed25"]] || 0) : 0;
    const oldGLs = oldRow ? Number(oldRow[oldMap["UltimateGLCount"]] || 0) : 0;

    // differences
    const diffCharGP = newCharGP - oldCharGP;
    const diffShipGP = newShipGP - oldShipGP;
    const diffTotalGP = newTotalGP - oldTotalGP;
    const diffMod = newModScore - oldModScore;
    const diffGear = newGearScore - oldGearScore;
    const diffTotalScore = newTotalScore - oldTotalScore;
    const diffZetas = newZetas - oldZetas;
    const diffOmis = newOmis - oldOmis;
    const diffSpeed20 = newSpeed20 - oldSpeed20;
    const diffSpeed25 = newSpeed25 - oldSpeed25;
    const diffGLs = newGLs - oldGLs;

    const playerName = (row[newMap["Name"]] || "").trim();
    const playerLink = allyNew
      ? `<a href="https://swgoh.gg/p/${encodeURIComponent(allyNew)}/" target="_blank" rel="noopener noreferrer">${escapeHtml(playerName)}</a>`
      : escapeHtml(playerName);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="text-align:left">${playerLink}</td>

      <td data-cur="${newCharGP}" data-diff="${diffCharGP}">
        ${newCharGP.toLocaleString()}
        <span class="oldVal">(${oldCharGP.toLocaleString()})</span>
        ${formatDiff(diffCharGP, 0)}
      </td>

      <td data-cur="${newShipGP}" data-diff="${diffShipGP}">
        ${newShipGP.toLocaleString()}
        <span class="oldVal">(${oldShipGP.toLocaleString()})</span>
        ${formatDiff(diffShipGP, 0)}
      </td>

      <td data-cur="${newTotalGP}" data-diff="${diffTotalGP}">
        ${newTotalGP.toLocaleString()}
        <span class="oldVal">(${oldTotalGP.toLocaleString()})</span>
        ${formatDiff(diffTotalGP, 0)}
      </td>

      <td>${escapeHtml(row[newMap["LeagueId"]] || "")}</td>
      <td>${escapeHtml(row[newMap["SkillRating"]] || "")}</td>

      <td data-cur="${newModScore.toFixed(2)}" data-diff="${diffMod}">
        ${newModScore.toFixed(2)}
        <span class="oldVal">(${oldModScore.toFixed(2)})</span>
        ${formatDiff(diffMod, 2)}
      </td>

      <td data-cur="${newGearScore.toFixed(2)}" data-diff="${diffGear}">
        ${newGearScore.toFixed(2)}
        <span class="oldVal">(${oldGearScore.toFixed(2)})</span>
        ${formatDiff(diffGear, 2)}
      </td>

      <td data-cur="${newTotalScore.toFixed(2)}" data-diff="${diffTotalScore}">
        ${newTotalScore.toFixed(2)}
        <span class="oldVal">(${oldTotalScore.toFixed(2)})</span>
        ${formatDiff(diffTotalScore, 2)}
      </td>

      <td>
        ${newZetas}
        <span class="oldVal">(${oldZetas})</span>
        ${formatDiff(diffZetas, 0)}
      </td>

      <td>
        ${newOmis}
        <span class="oldVal">(${oldOmis})</span>
        ${formatDiff(diffOmis, 0)}
      </td>

      <td>
        ${newSpeed20}
        <span class="oldVal">(${oldSpeed20})</span>
        ${formatDiff(diffSpeed20, 0)}
      </td>

      <td>
        ${newSpeed25}
        <span class="oldVal">(${oldSpeed25})</span>
        ${formatDiff(diffSpeed25, 0)}
      </td>

      <td>
        ${newGLs}
        <span class="oldVal">(${oldGLs})</span>
        ${formatDiff(diffGLs, 0)}
      </td>
    `;
    tbody.appendChild(tr);
  });

  makeSortable();
  addTopThreeEmojis();
  renderWinnersStrip(); // populate inline winners strip
}

function makeSortable() {
  const headers = document.querySelectorAll("th[data-col]");
  headers.forEach(th => {
    th.style.userSelect = "none";
    th.onclick = () => {
      const col = th.getAttribute("data-col");
      sortTable(col);
      headers.forEach(h => h.style.opacity = h === th ? "1" : "0.85");
    };
  });
}

function sortTable(col) {
  const table = document.getElementById("guildTable");
  const rows = Array.from(table.tBodies[0].rows);
  const headerCells = Array.from(table.tHead.rows[0].cells);
  const idx = headerCells.findIndex(c => c.getAttribute("data-col") === col);
  if (idx === -1) return;

  rows.sort((a, b) => {
    const numA = extractLeadingNumber(a.cells[idx].innerText);
    const numB = extractLeadingNumber(b.cells[idx].innerText);
    return numB - numA; // Descending
  });

  rows.forEach(r => table.tBodies[0].appendChild(r));
}

// Rank and decorate top 3 with emojis (only for Total GP Growth and Total Score Growth)
function addTopThreeEmojis() {
  const table = document.getElementById("guildTable");
  const rows = Array.from(table.tBodies[0].rows);
  const emojis = ["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"];

  // Column indices (by header order)
  // 0: Name, 1: CharacterGP, 2: ShipGP, 3: TotalGP, 4: League, 5: SkillRating,
  // 6: ModScore, 7: GearScore, 8: TotalScore, 9: Zeta, 10: Omi, 11: Speed20, 12: Speed25, 13: GL
  const TOTAL_GP_IDX = 3;
  const TOTAL_SCORE_IDX = 8;

  // Clear any previous emojis in those columns first (to avoid duplicates on re-render)
  rows.forEach(r => {
    [TOTAL_GP_IDX, TOTAL_SCORE_IDX].forEach(idx => {
      const cell = r.cells[idx];
      if (cell) {
        cell.innerHTML = cell.innerHTML.replace(/ ðŸ¥‡| ðŸ¥ˆ| ðŸ¥‰/g, "");
      }
    });
  });

  // Helper to award emojis based on diff, only for positive diffs
  function awardByDiff(idx) {
    const ranked = rows.map(r => {
      const cell = r.cells[idx];
      const diff = Number(cell.getAttribute("data-diff") || 0);
      const name = r.cells[0].innerText || "";
      return { cell, diff, name };
    })
    .filter(e => e.diff > 0) // only positive changes
    .sort((a, b) => b.diff - a.diff);

    ranked.slice(0, 3).forEach((entry, rank) => {
      const emoji = emojis[rank];
      if (!entry.cell.innerHTML.includes(emoji)) {
        entry.cell.innerHTML = entry.cell.innerHTML + " " + emoji;
      }
    });

    return ranked.slice(0, 3); // return top entries for strip rendering
  }

  const gpWinners = awardByDiff(TOTAL_GP_IDX);
  const scoreWinners = awardByDiff(TOTAL_SCORE_IDX);

  // Save winners data on the table element for the winners strip to read
  const tableEl = document.getElementById("guildTable");
  tableEl._gpWinners = gpWinners;
  tableEl._scoreWinners = scoreWinners;
}

// Render the inline winners strip (integrated into page)
function renderWinnersStrip() {
  const tableEl = document.getElementById("guildTable");
  const gpWinners = tableEl._gpWinners || [];
  const scoreWinners = tableEl._scoreWinners || [];

  const gpContainer = document.getElementById("gpGrowth");
  const scoreContainer = document.getElementById("scoreGrowth");

  // clear existing rows (keep title)
  gpContainer.querySelectorAll(".winner-row").forEach(n => n.remove());
  scoreContainer.querySelectorAll(".winner-row").forEach(n => n.remove());

  function renderCategory(container, winners, valueLabel) {
    if (!winners.length) {
      const row = document.createElement("div");
      row.className = "winner-row";
      row.innerHTML = `<div class="medal">â€”</div><div class="winner-name">No positive growth</div><div class="winner-val"></div>`;
      container.appendChild(row);
      return;
    }
    winners.forEach((w, i) => {
      const row = document.createElement("div");
      row.className = "winner-row";
      const emoji = i === 0 ? "ðŸ¥‡" : i === 1 ? "ðŸ¥ˆ" : "ðŸ¥‰";
      const nameText = (w.name || "").trim() || "Unknown";
      const valueText = (typeof w.diff === "number") ? (w.diff > 0 ? `+${Number(w.diff).toLocaleString()}` : `${Number(w.diff).toLocaleString()}`) : "";
      row.innerHTML = `<div class="medal">${emoji}</div><div class="winner-name" title="${escapeHtml(nameText)}">${escapeHtml(nameText)}</div><div class="winner-val">${escapeHtml(valueText)}</div>`;
      container.appendChild(row);
    });
  }

  renderCategory(gpContainer, gpWinners, "GP");
  renderCategory(scoreContainer, scoreWinners, "Score");
}

// Toggle winners strip visibility (integrated, non-blocking)
document.addEventListener("click", (e) => {
  const btn = document.getElementById("toggleWinners");
  if (!btn) return;
  btn.addEventListener("click", () => {
    const container = document.getElementById("winnersContainer");
    if (!container) return;
    const isHidden = container.style.display === "none";
    container.style.display = isHidden ? "flex" : "none";
    btn.textContent = isHidden ? "Hide winners" : "Show winners";
    btn.setAttribute("aria-expanded", String(isHidden));
  }, { once: true });
  // The above attaches the handler once on first click event dispatch; ensure handler exists immediately:
}, { once: true });

// Attach handler immediately (safer)
(function attachToggle() {
  const btn = document.getElementById("toggleWinners");
  const container = document.getElementById("winnersContainer");
  if (!btn || !container) return;
  btn.addEventListener("click", () => {
    const isHidden = container.style.display === "none";
    container.style.display = isHidden ? "flex" : "none";
    btn.textContent = isHidden ? "Hide winners" : "Show winners";
    btn.setAttribute("aria-expanded", String(isHidden));
  });
})();

// helpers
function extractLeadingNumber(text) {
  if (!text) return 0;
  const m = text.replace(/[,+]/g, "").match(/-?\d+(\.\d+)?/);
  return m ? Number(m[0]) : 0;
}

function escapeHtml(str) {
  if (typeof str !== "string") return "";
  return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}
</script>
</body>
</html>
