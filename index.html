<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chewbooty Guild Roster</title>
  <style>
    body { font-family: Arial, sans-serif; background:#1c1c1c; color:#f0f0f0; margin:20px; }
    h1 { text-align:center; color:#ffd700; }
    table { width:100%; border-collapse:collapse; margin-top:20px; background:#2a2a2a; }
    th, td { border:1px solid #444; padding:6px 8px; text-align:center; }
    th { background:#333; color:#ffd700; cursor:pointer; position:sticky; top:0; }
    tr:nth-child(even) { background:#242424; }
    tr:hover { background:#3a3a3a; }
    .pos { color:#00ff00; font-weight:bold; }   /* green for positive */
    .neg { color:#ff4444; font-weight:bold; }   /* red for negative */
    .zero { color:#bbb; font-weight:bold; }     /* gray for zero */
    a { color:#66ccff; text-decoration:none; }
    a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <h1>Chewbooty Guild Roster</h1>
  <table id="guildTable">
    <thead>
      <tr>
        <th data-col="Name">Player</th>
        <th data-col="AllyCode">SWGOH.gg</th>
        <th data-col="CharacterGP">Character GP</th>
        <th data-col="ShipGP">Ship GP</th>
        <th data-col="TotalGP">Total GP</th>
        <th data-col="LeagueId">League</th>
        <th data-col="SkillRating">Skill Rating</th>
        <th data-col="G13Count">G13</th>
        <th data-col="Relics">Relics</th>
        <th data-col="ZetaCount">Zetas</th>
        <th data-col="OmiCount">Omicrons</th>
        <th data-col="Speed20">Speed ≥20</th>
        <th data-col="Speed25">Speed ≥25</th>
        <th data-col="UltimateGLCount">Ultimate GL</th>
        <th data-col="TotalScore">Total Score</th>
        <th data-col="GearScore">Gear Score</th>
        <th data-col="ModScore">Mod Score</th>
        <th>Net Change (GP)</th>
        <th>Net Change (Total Score)</th>
        <th>Net Change (Gear Score)</th>
        <th>Net Change (Mod Score)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const FILES = ["ChewbootyOld.csv","Chewbooty.csv"]; // always compare these two

function parseCSV(csvText) {
  const rows = csvText.trim().split(/\r?\n/).map(r => r.split(','));
  return {header: rows[0], data: rows.slice(1)};
}

function indexMap(header) {
  const idx = {};
  header.forEach((h,i)=>{ idx[h.trim()] = i; });
  return idx;
}

function toNumber(v) {
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

function sumSlice(row,start,end) {
  if (start<0 || end<0) return 0;
  return row.slice(start,end+1).reduce((s,v)=>s+toNumber(v),0);
}

function linkForAlly(ally) {
  if (!ally) return '';
  const code = String(ally).trim();
  return `<a href="https://swgoh.gg/p/${code}/" target="_blank" rel="noopener">${code}</a>`;
}

function formatDiff(diff,isScore=false) {
  const cls = diff>0?'pos':diff<0?'neg':'zero';
  const val = isScore?diff.toFixed(2):diff.toLocaleString();
  return `<span class="${cls}">${diff>0?'+':''}${val}</span>`;
}

function findMatch(oldData,oldIdx,newRow,newIdx) {
  const allyNew = newRow[newIdx['AllyCode']];
  let match = null;
  if (allyNew) {
    match = oldData.find(r => String(r[oldIdx['AllyCode']]).trim() === String(allyNew).trim());
  }
  if (!match) {
    const nameNew = newRow[newIdx['Name']]?.trim();
    match = oldData.find(r => String(r[oldIdx['Name']]).trim() === nameNew);
  }
  return match;
}

function renderComparison(oldText,newText) {
  const oldParsed = parseCSV(oldText);
  const newParsed = parseCSV(newText);

  const oldIdx = indexMap(oldParsed.header);
  const newIdx = indexMap(newParsed.header);

  const tbody = document.querySelector("#guildTable tbody");
  tbody.innerHTML = "";

  newParsed.data.forEach(row => {
    const charGP = toNumber(row[newIdx['CharacterGP']]);
    const shipGP = toNumber(row[newIdx['ShipGP']]);
    const totalGP = charGP + shipGP;

    const relics = sumSlice(row,newIdx['Relic1Count'],newIdx['Relic9Count']);
    const totalScoreNew = toNumber(row[newIdx['TotalScore']]);
    const gearScoreNew = toNumber(row[newIdx['GearScore']]);
    const modScoreNew = toNumber(row[newIdx['ModScore']]);

    const oldRow = findMatch(oldParsed.data,oldIdx,row,newIdx);

    let diffGP=0,diffScore=0,diffGear=0,diffMod=0;
    if (oldRow) {
      const oldCharGP = toNumber(oldRow[oldIdx['CharacterGP']]);
      const oldShipGP = toNumber(oldRow[oldIdx['ShipGP']]);
      const oldTotalGP = oldCharGP+oldShipGP;
      diffGP = totalGP-oldTotalGP;

      const oldTotalScore = toNumber(oldRow[oldIdx['TotalScore']]);
      diffScore = totalScoreNew-oldTotalScore;

      const oldGearScore = toNumber(oldRow[oldIdx['GearScore']]);
      diffGear = gearScoreNew-oldGearScore;

      const oldModScore = toNumber(oldRow[oldIdx['ModScore']]);
      diffMod = modScoreNew-oldModScore;
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row[newIdx['Name']]}</td>
      <td>${linkForAlly(row[newIdx['AllyCode']])}</td>
      <td>${charGP.toLocaleString()}</td>
      <td>${shipGP.toLocaleString()}</td>
      <td>${totalGP.toLocaleString()}</td>
      <td>${row[newIdx['LeagueId']]}</td>
      <td>${row[newIdx['SkillRating']]}</td>
      <td>${row[newIdx['G13Count']]}</td>
      <td>${relics}</td>
      <td>${row[newIdx['ZetaCount']]}</td>
      <td>${row[newIdx['OmiCount']]}</td>
      <td>${row[newIdx['Speed20']]}</td>
      <td>${row[newIdx['Speed25']]}</td>
      <td>${row[newIdx['UltimateGLCount']]}</td>
      <td>${totalScoreNew}</td>
      <td>${gearScoreNew}</td>
      <td>${modScoreNew}</td>
      <td>${formatDiff(diffGP)}</td>
      <td>${formatDiff(diffScore,true)}</td>
      <td>${formatDiff(diffGear,true)}</td>
      <td>${formatDiff(diffMod,true)}</td>
    `;
    tbody.appendChild(tr);
  });

  makeSortable();
}

function makeSortable() {
  const headers = document.querySelectorAll("th[data-col]");
  headers.forEach(th=>{
    th.onclick=()=>{
      const col=th.getAttribute("data-col");
      sortTable(col);
    };
  });
}

function sortTable(col) {
  const table=document.getElementById("guildTable");
  const rows=Array.from(table.tBodies[0].rows);
  const idx=Array.from(table.tHead.rows[0].cells).findIndex(c=>c.getAttribute("data-col")===col);
  rows.sort((a,b)=>{
    const rawA=a.cells[idx].innerText.trim();
    const rawB=b.cells[idx].innerText.trim();
    const cleanA=rawA.replace(/[,+]/g,"");
    const cleanB=rawB.replace(/[,+]/g,"");
    const numA=Number(cleanA);
    const numB=Number(cleanB);
    if (!Number.isNaN(numA) && !Number.isNaN(numB)) {
      return numB-numA; // descending numeric sort
    }
    return rawA.localeCompare(rawB);
  });
  rows.forEach(r=>table.tBodies[0].appendChild(r));
}

// Fetch both files and render
Promise.all(FILES.map(f => fetch(f).then(r => r.text())))
  .then(([oldCSV,newCSV]) => renderComparison(oldCSV,newCSV))
  .catch(err => {
    console.error("Error loading CSVs:", err);
  });
</script>
</body>
</html>
