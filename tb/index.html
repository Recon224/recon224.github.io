<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guild TB Stats Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: sans-serif; }
        .header-area { background: #1a2a3a; color: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem; }
        .table thead th { background-color: #2c3e50; color: white; white-space: nowrap; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="header-area d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-0">Guild TB Performance</h2>
            <small id="status">Searching for data files...</small>
        </div>
        <div>
            <label class="fw-bold text-light small d-block">Select TB Date:</label>
            <select id="dateSelector" class="form-select" onchange="loadCsvData(this.value)"></select>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <table id="statsTable" class="table table-striped table-hover" style="width:100%">
                <thead><tr id="tableHeader"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
    let dataTable;

    async function scanForFiles() {
        const selector = document.getElementById('dateSelector');
        const foundFiles = [];
        
        // We will check the last 100 weeks (roughly 2 years) for files
        let checkDate = new Date(); 
        // Set to the most recent Sunday (common TB end day) to start the search
        checkDate.setDate(checkDate.getDate() + (7 - checkDate.getDay()) % 7);

        document.getElementById('status').innerText = "Scanning for files...";

        for (let i = 0; i < 100; i++) {
            const dateStr = checkDate.toISOString().split('T')[0];
            const fileName = `tb_${dateStr}.csv`;
            
            try {
                // We use a HEAD request to see if the file exists without downloading it
                const response = await fetch(fileName, { method: 'HEAD' });
                if (response.ok) {
                    foundFiles.push(fileName);
                }
            } catch (e) { /* File doesn't exist, skip */ }
            
            // Move back 7 days for the next check
            checkDate.setDate(checkDate.getDate() - 7);
        }

        if (foundFiles.length === 0) {
            // If no Sunday files found, try one specific check for your 2025-12-28 file
            // as a backup in case the Sunday logic misses it.
            const manualFile = "tb_2025-12-28.csv";
            const resp = await fetch(manualFile, { method: 'HEAD' });
            if (resp.ok) foundFiles.push(manualFile);
        }

        if (foundFiles.length > 0) {
            foundFiles.forEach((file, index) => {
                let opt = new Option(file.replace('tb_','').replace('.csv','') + (index === 0 ? " (Latest)" : ""), file);
                selector.add(opt);
            });
            loadCsvData(foundFiles[0]);
        } else {
            document.getElementById('status').innerText = "No files found. Ensure name is tb_YYYY-MM-DD.csv";
        }
    }

    function loadCsvData(filename) {
        Papa.parse(filename, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                renderTable(results.data);
                document.getElementById('status').innerText = "Viewing: " + filename;
            }
        });
    }

    function renderTable(data) {
        if (dataTable) dataTable.destroy();
        const headerRow = document.getElementById('tableHeader');
        const body = document.getElementById('tableBody');
        headerRow.innerHTML = ''; body.innerHTML = '';

        if (!data || data.length === 0) return;
        const columns = Object.keys(data[0]);
        
        columns.forEach(col => {
            let th = document.createElement('th');
            th.innerText = col.replace(/P(\d)/g, 'Phase $1 ');
            headerRow.appendChild(th);
        });

        data.forEach(row => {
            let tr = document.createElement('tr');
            columns.forEach(col => {
                let td = document.createElement('td');
                let val = row[col];
                td.innerText = (typeof val === 'number') ? val.toLocaleString() : (val || '-');
                tr.appendChild(td);
            });
            body.appendChild(tr);
        });

        dataTable = $('#statsTable').DataTable({
            pageLength: 25,
            order: [[1, 'desc']], 
            scrollX: true
        });
    }

    scanForFiles();
</script>
</body>
</html>
