<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guild TB Stats Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .header-area { background: #1a2a3a; color: white; padding: 2rem; border-radius: 10px; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card { border: none; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.05); }
        .table thead th { background-color: #2c3e50; color: white; white-space: nowrap; font-weight: 500; }
        .status-pill { padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; background: #e9ecef; border: 1px solid #dee2e6; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="header-area d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h1 class="h3 mb-1">Territory Battle Performance</h1>
            <span class="status-pill" id="fileStatus">Scanning repository...</span>
        </div>
        <div class="mt-3 mt-md-0">
            <label class="form-label d-block fw-bold text-light small">Select TB Date:</label>
            <select id="dateSelector" class="form-select" style="min-width: 200px;" onchange="loadCsvData(this.value)">
                </select>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <table id="statsTable" class="table table-striped table-hover" style="width:100%">
                <thead><tr id="tableHeader"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
    let dataTable;

    // --- CONFIGURATION ---
    // Update these two variables to match your GitHub details
    const GITHUB_USER = "YourGitHubUsername"; 
    const GITHUB_REPO = "YourRepoName";
    // ---------------------

    async function init() {
        // Automatically try to detect username and repo from URL if not set
        let user = GITHUB_USER === "YourGitHubUsername" ? window.location.hostname.split('.')[0] : GITHUB_USER;
        let repo = GITHUB_REPO === "YourRepoName" ? window.location.pathname.split('/')[1] : GITHUB_REPO;

        const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/`;
        
        try {
            const response = await fetch(apiUrl);
            const files = await response.json();
            
            // Filter for files matching tb_YYYY-MM-DD.csv
            const tbFiles = files
                .filter(f => f.name.startsWith('tb_') && f.name.endsWith('.csv'))
                .map(f => f.name)
                .sort()
                .reverse(); // Newest date first

            if (tbFiles.length === 0) {
                document.getElementById('fileStatus').innerText = "No files found. Ensure names are like tb_2023-11-24.csv";
                return;
            }

            const selector = document.getElementById('dateSelector');
            tbFiles.forEach((filename, index) => {
                let datePart = filename.replace('tb_', '').replace('.csv', '');
                let opt = new Option(datePart + (index === 0 ? " (Latest)" : ""), filename);
                selector.add(opt);
            });

            loadCsvData(tbFiles[0]);

        } catch (error) {
            console.error("Error fetching file list:", error);
            document.getElementById('fileStatus').innerText = "Error connecting to GitHub API.";
        }
    }

    function loadCsvData(filename) {
        document.getElementById('fileStatus').innerText = "Loading " + filename + "...";
        
        Papa.parse(filename, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                renderTable(results.data);
                document.getElementById('fileStatus').innerText = "Showing: " + filename;
            }
        });
    }

    function renderTable(data) {
        if (dataTable) dataTable.destroy();
        
        const headerRow = document.getElementById('tableHeader');
        const body = document.getElementById('tableBody');
        headerRow.innerHTML = '';
        body.innerHTML = '';

        if (!data || data.length === 0) return;

        const columns = Object.keys(data[0]);
        
        columns.forEach(col => {
            let th = document.createElement('th');
            // Make Phase names cleaner (e.g., P1 Waves -> Phase 1 Waves)
            th.innerText = col.replace(/P(\d)/g, 'Phase $1 ');
            headerRow.appendChild(th);
        });

        data.forEach(row => {
            let tr = document.createElement('tr');
            columns.forEach(col => {
                let td = document.createElement('td');
                let val = row[col];
                td.innerText = (typeof val === 'number') ? val.toLocaleString() : (val || '-');
                tr.appendChild(td);
            });
            body.appendChild(tr);
        });

        dataTable = $('#statsTable').DataTable({
            pageLength: 25,
            order: [[1, 'desc']], // Default sort by Total Points
            scrollX: true,
            dom: '<"d-flex justify-content-between"fB>rtip',
        });
    }

    init();
</script>

</body>
</html>
